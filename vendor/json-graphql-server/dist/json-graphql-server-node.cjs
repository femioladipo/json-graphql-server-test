"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const o=require("graphql"),ge=require("@graphql-tools/schema"),m=require("inflection"),C=require("graphql-type-json");function F(e){return typeof e=="object"&&e!==null}function ye(e){return F(e)&&("data"in e||"data"in e&&e.data==null&&"errors"in e)}function de(e){return typeof Object(e)[Symbol.asyncIterator]=="function"}function N(e){if(!Array.isArray(e)||typeof e[0]!="string"&&e[0]!==null||!F(e[1]))return!1;const t=e[1];return!(t.status&&typeof t.status!="number"||t.statusText&&typeof t.statusText!="string"||t.headers&&!F(t.headers))}async function q(e){var t,r;const n=e.method;if(n!=="GET"&&n!=="POST")return[null,{status:405,statusText:"Method Not Allowed",headers:{allow:"GET, POST"}}];const[s,a="charset=utf-8"]=(K(e,"content-type")||"").replace(/\s/g,"").toLowerCase().split(";"),i={};switch(!0){case n==="GET":{try{const[,l]=e.url.split("?"),h=new URLSearchParams(l);i.operationName=(t=h.get("operationName"))!==null&&t!==void 0?t:void 0,i.query=(r=h.get("query"))!==null&&r!==void 0?r:void 0;const p=h.get("variables");p&&(i.variables=JSON.parse(p));const c=h.get("extensions");c&&(i.extensions=JSON.parse(c))}catch{throw new Error("Unparsable URL")}break}case(n==="POST"&&s==="application/json"&&a==="charset=utf-8"):{if(!e.body)throw new Error("Missing body");let l;try{const h=typeof e.body=="function"?await e.body():e.body;l=typeof h=="string"?JSON.parse(h):h}catch{throw new Error("Unparsable JSON body")}if(!F(l))throw new Error("JSON body must be an object");i.operationName=l.operationName,i.query=l.query,i.variables=l.variables,i.extensions=l.extensions;break}default:return[null,{status:415,statusText:"Unsupported Media Type"}]}if(i.query==null)throw new Error("Missing query");if(typeof i.query!="string")throw new Error("Invalid query");if(i.variables!=null&&(typeof i.variables!="object"||Array.isArray(i.variables)))throw new Error("Invalid variables");if(i.operationName!=null&&typeof i.operationName!="string")throw new Error("Invalid operationName");if(i.extensions!=null&&(typeof i.extensions!="object"||Array.isArray(i.extensions)))throw new Error("Invalid extensions");return i}function me(e){const{schema:t,context:r,validate:n=o.validate,validationRules:s=[],execute:a=o.execute,parse:i=o.parse,getOperationAST:l=o.getOperationAST,rootValue:h,onSubscribe:p,onOperation:c,formatError:f=b=>b,parseRequestParams:w=q}=e;return async function(y){let T=null;const R=(K(y,"accept")||"*/*").replace(/\s/g,"").toLowerCase().split(",");for(const g of R){const[L,..._]=g.split(";"),S=(_==null?void 0:_.find(G=>G.includes("charset=")))||"charset=utf-8";if(L==="application/graphql-response+json"&&S==="charset=utf-8"){T="application/graphql-response+json";break}if((L==="application/json"||L==="application/*"||L==="*/*")&&(S==="charset=utf-8"||S==="charset=utf8")){T="application/json";break}}if(!T)return[null,{status:406,statusText:"Not Acceptable",headers:{accept:"application/graphql-response+json; charset=utf-8, application/json; charset=utf-8"}}];let O;try{let g=await w(y);if(g||(g=await q(y)),N(g))return g;O=g}catch(g){return E(g,T,f)}let u;const I=await(p==null?void 0:p(y,O));if(N(I))return I;if(ye(I)||ee(I))return E(I,T,f);if(I)u=I;else{if(!t)throw new Error("The GraphQL schema is not provided");const{operationName:g,query:L,variables:_}=O;let S;try{S=i(L)}catch(Q){return E(Q,T,f)}const G=typeof r=="function"?await r(y,O):r;if(N(G))return G;const M={operationName:g,document:S,variableValues:_,contextValue:G};if(typeof t=="function"){const Q=await t(y,M);if(N(Q))return Q;u=Object.assign(Object.assign({},M),{schema:Q})}else u=Object.assign(Object.assign({},M),{schema:t});let A=o.specifiedRules;typeof s=="function"?A=await s(y,u,o.specifiedRules):A=[...A,...s];const J=n(u.schema,u.document,A);if(J.length)return E(J,T,f)}let $;try{const g=l(u.document,u.operationName);if(!g)throw null;$=g.operation}catch{return E(new o.GraphQLError("Unable to detect operation AST"),T,f)}if($==="subscription")return E(new o.GraphQLError("Subscriptions are not supported"),T,f);if($==="mutation"&&y.method==="GET")return[JSON.stringify({errors:[new o.GraphQLError("Cannot perform mutations over GET")]}),{status:405,statusText:"Method Not Allowed",headers:{allow:"POST"}}];if("rootValue"in u||(u.rootValue=h),!("contextValue"in u)){const g=typeof r=="function"?await r(y,O):r;if(N(g))return g;u.contextValue=g}let D=await a(u);const x=await(c==null?void 0:c(y,u,D));return N(x)?x:(x&&(D=x),de(D)?E(new o.GraphQLError("Subscriptions are not supported"),T,f):E(D,T,f))}}function E(e,t,r){if(e instanceof Error&&!v(e))return[JSON.stringify({errors:[r(e)]},V),{status:400,statusText:"Bad Request",headers:{"content-type":"application/json; charset=utf-8"}}];const n=v(e)?[e]:ee(e)?e:null;return n?[JSON.stringify({errors:n.map(r)},V),Object.assign(Object.assign({},t==="application/json"?{status:200,statusText:"OK"}:{status:400,statusText:"Bad Request"}),{headers:{"content-type":t==="application/json"?"application/json; charset=utf-8":"application/graphql-response+json; charset=utf-8"}})]:[JSON.stringify("errors"in e&&e.errors?Object.assign(Object.assign({},e),{errors:e.errors.map(r)}):e,V),{status:200,statusText:"OK",headers:{"content-type":t==="application/json"?"application/json; charset=utf-8":"application/graphql-response+json; charset=utf-8"}}]}function K(e,t){return typeof e.headers.get=="function"?e.headers.get(t):Object(e.headers)[t]}function ee(e){return Array.isArray(e)&&e.length>0&&e.some(v)}function v(e){return e instanceof o.GraphQLError}function V(e,t){return t instanceof Error&&!v(t)?{message:t.message}:t}function Te(e){const t=me(e);return async function(n,s){try{const[a,i]=await t(Oe(n,s));s.writeHead(i.status,i.statusText,i.headers).end(a)}catch(a){console.error("Internal error occurred during request handling. Please check your implementation.",a),s.writeHead(500).end()}}}function Oe(e,t){return{url:e.url,method:e.method,headers:e.headers,body:()=>e.body?e.body:new Promise(r=>{let n="";e.setEncoding("utf-8"),e.on("data",s=>n+=s),e.on("end",()=>r(n))}),raw:e,context:{res:t}}}var B;(function(e){e.NAME="Name",e.DOCUMENT="Document",e.OPERATION_DEFINITION="OperationDefinition",e.VARIABLE_DEFINITION="VariableDefinition",e.SELECTION_SET="SelectionSet",e.FIELD="Field",e.ARGUMENT="Argument",e.FRAGMENT_SPREAD="FragmentSpread",e.INLINE_FRAGMENT="InlineFragment",e.FRAGMENT_DEFINITION="FragmentDefinition",e.VARIABLE="Variable",e.INT="IntValue",e.FLOAT="FloatValue",e.STRING="StringValue",e.BOOLEAN="BooleanValue",e.NULL="NullValue",e.ENUM="EnumValue",e.LIST="ListValue",e.OBJECT="ObjectValue",e.OBJECT_FIELD="ObjectField",e.DIRECTIVE="Directive",e.NAMED_TYPE="NamedType",e.LIST_TYPE="ListType",e.NON_NULL_TYPE="NonNullType",e.SCHEMA_DEFINITION="SchemaDefinition",e.OPERATION_TYPE_DEFINITION="OperationTypeDefinition",e.SCALAR_TYPE_DEFINITION="ScalarTypeDefinition",e.OBJECT_TYPE_DEFINITION="ObjectTypeDefinition",e.FIELD_DEFINITION="FieldDefinition",e.INPUT_VALUE_DEFINITION="InputValueDefinition",e.INTERFACE_TYPE_DEFINITION="InterfaceTypeDefinition",e.UNION_TYPE_DEFINITION="UnionTypeDefinition",e.ENUM_TYPE_DEFINITION="EnumTypeDefinition",e.ENUM_VALUE_DEFINITION="EnumValueDefinition",e.INPUT_OBJECT_TYPE_DEFINITION="InputObjectTypeDefinition",e.DIRECTIVE_DEFINITION="DirectiveDefinition",e.SCHEMA_EXTENSION="SchemaExtension",e.SCALAR_TYPE_EXTENSION="ScalarTypeExtension",e.OBJECT_TYPE_EXTENSION="ObjectTypeExtension",e.INTERFACE_TYPE_EXTENSION="InterfaceTypeExtension",e.UNION_TYPE_EXTENSION="UnionTypeExtension",e.ENUM_TYPE_EXTENSION="EnumTypeExtension",e.INPUT_OBJECT_TYPE_EXTENSION="InputObjectTypeExtension"})(B||(B={}));const Ee=/\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3}Z/,te=e=>typeof e!="string"||!Ee.test(e)?!1:new Date(e).toISOString()===e,U="Date",re=new o.GraphQLScalarType({name:U,description:"Date type",parseValue(e){return new Date(e)},serialize(e){return te(e)?e:e.toISOString()},parseLiteral(e){if(e.kind!==B.STRING)throw new o.GraphQLError(`Query error: Can only parse dates strings, got a: ${e.kind}`,{nodes:[e]});if(Number.isNaN(Date.parse(e.value)))throw new o.GraphQLError("Query error: not a valid date",{nodes:[e]});return new Date(e.value)}}),be=e=>!Number.isNaN(Number.parseFloat(e))&&Number.isFinite(e),Y=e=>e.every(be),Ie=e=>Number.isInteger(e),z=e=>e.every(Ie),Le=e=>typeof e=="boolean",H=e=>e.every(Le),Se=e=>typeof e=="string",X=e=>e.every(Se),Ne=e=>Array.isArray(e),je=e=>e.every(Ne),we=e=>e instanceof Date||te(e),_e=e=>e.every(we),Ge=e=>Object.prototype.toString.call(e)==="[object Object]",W=e=>e.every(Ge),d=(e,t)=>t?new o.GraphQLNonNull(e):e,ne=(e,t=[],r=!1)=>{if(e==="id"||e.substr(e.length-3)==="_id")return d(o.GraphQLID,r);if(t.length>0){if(je(t)){const n=t.reduce((s,a)=>(a.forEach(i=>s.push(i)),s),[]);return H(n)?d(new o.GraphQLList(o.GraphQLBoolean),r):X(n)?d(new o.GraphQLList(o.GraphQLString),r):z(n)?d(new o.GraphQLList(o.GraphQLInt),r):Y(n)?d(new o.GraphQLList(o.GraphQLFloat),r):W(n)?d(C.GraphQLJSON,r):d(new o.GraphQLList(o.GraphQLString),r)}if(H(t))return d(o.GraphQLBoolean,r);if(_e(t))return d(re,r);if(X(t))return d(o.GraphQLString,r);if(z(t))return d(o.GraphQLInt,r);if(Y(t))return d(o.GraphQLFloat,r);if(W(t))return d(C.GraphQLJSON,r)}return d(o.GraphQLString,r)},se=e=>e.reduce((t,r)=>{for(const n of Object.keys(r))t[n]||(t[n]=[]),r[n]!=null&&t[n].push(r[n]);return t},{}),P=(e,t=!0)=>{const r=se(e),n=e.length;return Object.keys(r).reduce((s,a)=>(s[a]={type:ne(a,r[a],t?r[a].length===n:!1)},s),{})},Qe=e=>m.camelize(e),j=e=>m.camelize(m.singularize(e)),De=e=>m.pluralize(e.substr(0,e.length-3)),xe=e=>`${m.singularize(e)}_id`,oe=e=>j(e.substr(0,e.length-3)),Ae=e=>Object.keys(e).map(t=>({name:m.camelize(m.singularize(t)),fields:P(e[t])})).map(t=>new o.GraphQLObjectType(t)),Fe=e=>{const t=se(e);return Object.keys(t).reduce((r,n)=>{const s=ne(n,t[n],!1);return o.isListType(s)||((s===o.GraphQLInt||s===o.GraphQLFloat||s===o.GraphQLString||s.name===U)&&(r[`${n}_lt`]={type:s},r[`${n}_lte`]={type:s},r[`${n}_gt`]={type:s},r[`${n}_gte`]={type:s}),s!==o.GraphQLBoolean&&(r[`${n}_neq`]={type:s})),r},{})},ae=e=>Object.keys(e).reduce((t,r)=>Object.assign({},t,{[j(r)]:new o.GraphQLInputObjectType({name:`${j(r)}Filter`,fields:Object.assign({q:{type:o.GraphQLString}},{ids:{type:new o.GraphQLList(o.GraphQLID)}},P(e[r],!1),Fe(e[r]))})}),{}),ie=e=>e.endsWith("_id"),ce=e=>{const t=Ae(e),r=t.reduce((p,c)=>(p[c.name]=c,p),{}),n=ae(e),s=new o.GraphQLObjectType({name:"ListMetadata",fields:{count:{type:o.GraphQLInt}}}),a=new o.GraphQLObjectType({name:"Query",fields:t.reduce((p,c)=>(p[c.name]={type:r[c.name],args:{id:{type:new o.GraphQLNonNull(o.GraphQLID)}}},p[`all${m.camelize(m.pluralize(c.name))}`]={type:new o.GraphQLList(r[c.name]),args:{page:{type:o.GraphQLInt},perPage:{type:o.GraphQLInt},sortField:{type:o.GraphQLString},sortOrder:{type:o.GraphQLString},filter:{type:n[c.name]}}},p[`_all${m.camelize(m.pluralize(c.name))}Meta`]={type:s,args:{page:{type:o.GraphQLInt},perPage:{type:o.GraphQLInt},filter:{type:n[c.name]}}},p),{})}),i=new o.GraphQLObjectType({name:"Mutation",fields:t.reduce((p,c)=>{const f=r[c.name].getFields(),w=Object.keys(f).reduce((O,u)=>(O[u]=Object.assign({},f[u],{type:u!=="id"&&f[u].type instanceof o.GraphQLNonNull?f[u].type.ofType:f[u].type}),O),{}),{id:b,...y}=f,T=Object.keys(y).reduce((O,u)=>(O[u]=Object.assign({},y[u]),delete O[u].resolve,O),{}),R=new o.GraphQLInputObjectType({name:`${c.name}Input`,fields:T});return p[`create${c.name}`]={type:r[c.name],args:y},p[`createMany${c.name}`]={type:new o.GraphQLList(r[c.name]),args:{data:{type:new o.GraphQLList(R)}}},p[`update${c.name}`]={type:r[c.name],args:w},p[`remove${c.name}`]={type:r[c.name],args:{id:{type:new o.GraphQLNonNull(o.GraphQLID)}}},p[`delete${c.name}`]={type:r[c.name],args:{id:{type:new o.GraphQLNonNull(o.GraphQLID)}}},p},{})}),l=new o.GraphQLSchema({query:a,mutation:i}),h=Object.values(r).reduce((p,c)=>{let f=`${p}`;for(const w of Object.keys(c.getFields()).filter(ie)){const b=oe(w),y=m.pluralize(c.toString());f=`${f}
    extend type ${c} { ${b}: ${b} }
    extend type ${b} { ${y}: [${c}] }`}return f},"");return h?o.extendSchema(l,o.parse(h)):l},pe=(e=[],t={})=>{let r=[...e];return t.ids?r=r.filter(n=>t.ids.some(s=>s==n.id)):(Object.keys(t).filter(n=>n!=="q").forEach(n=>{if(n.indexOf("_neq")!==-1){const s=n.replace(/(_neq)$/,"");r=r.filter(a=>t[n]instanceof Date&&typeof a[s]=="string"?a[s]!=t[n].toISOString():a[s]!=t[n]);return}if(n.indexOf("_lte")!==-1){const s=n.replace(/(_lte)$/,"");r=r.filter(a=>t[n]instanceof Date&&typeof a[s]=="string"?a[s]<=t[n].toISOString():a[s]<=t[n]);return}if(n.indexOf("_gte")!==-1){const s=n.replace(/(_gte)$/,"");r=r.filter(a=>t[n]instanceof Date&&typeof a[s]=="string"?a[s]>=t[n].toISOString():a[s]>=t[n]);return}if(n.indexOf("_lt")!==-1){const s=n.replace(/(_lt)$/,"");r=r.filter(a=>t[n]instanceof Date&&typeof a[s]=="string"?a[s]<t[n].toISOString():a[s]<t[n]);return}if(n.indexOf("_gt")!==-1){const s=n.replace(/(_gt)$/,"");r=r.filter(a=>t[n]instanceof Date&&typeof a[s]=="string"?a[s]>t[n].toISOString():a[s]>t[n]);return}Array.isArray(t[n])?r=r.filter(s=>Array.isArray(s[n])?t[n].every(a=>s[n].some(i=>a instanceof Date&&typeof i=="string"?i==a.toISOString():i==a)):t[n].filter(a=>a instanceof Date&&typeof s[n]=="string"?s[n]==a.toISOString():a==s[n]).length>0):r=r.filter(s=>t[n]instanceof Date&&typeof s[n]=="string"?s[n]==t[n].toISOString():t[n]instanceof Date?+s[n]==+t[n]:s[n]==t[n])}),t.q&&(r=r.filter(n=>Object.keys(n).some(s=>{var a;return(a=n[s])==null?void 0:a.toString().toLowerCase().includes(t.q.toLowerCase())})))),r},ve=(e=[])=>(t,{sortField:r,sortOrder:n="asc",page:s,perPage:a=25,filter:i={}})=>{let l=[...e];if(r){const h=n.toLowerCase()=="asc"?1:-1;l=l.sort((p,c)=>p[r]>c[r]?h:p[r]<c[r]?-1*h:0)}return l=pe(l,i),s!==void 0&&a&&(l=l.slice(s*a,s*a+a)),l},Pe=e=>(t,{filter:r={}})=>({count:pe(e,r).length}),Re=(e=[])=>(t,{id:r})=>e.find(n=>n.id==r),ue=(e=[])=>(t,r)=>{const n=e.length>0?e[e.length-1].id+1:0,s=Object.assign({},r,{id:r.id??n});return e.push(s),s},$e=(e=[])=>(t,r)=>r.data.map(n=>ue(e)(null,n)),Me=(e=[])=>(t,r)=>{let n;if(r.id!=null){const s=r.id.toString(),a=e.findIndex(i=>i.id!=null&&i.id.toString()===s);a!==-1&&(e[a]=Object.assign({},e[a],r),n=e[a])}return n},Z=(e=[])=>(t,{id:r})=>{let n;if(r!=null){const s=r.toString(),a=e.findIndex(i=>i.id!=null&&i.id.toString()===s);a!==-1&&(n=e.splice(a,1)[0])}return n},Ve=(e,t)=>{const n=Object.keys(P(t[e])).filter(ie).reduce((h,p)=>Object.assign({},h,{[oe(p)]:c=>t[De(p)].find(f=>f.id==c[p])}),{}),s=xe(e),a=h=>Object.keys(P(t[h])).includes(s),l=Object.keys(t).filter(a).reduce((h,p)=>Object.assign({},h,{[Qe(p)]:c=>t[p].filter(f=>f[s]==c.id)}),{});return Object.assign({},n,l)},k=(e,t)=>Object.values(ae(t)).reduce((r,n)=>r?!0:Object.values(n.getFields()).reduce((s,a)=>s?!0:a.type.name==e,!1),!1),Ce=(e,t)=>({[`all${m.pluralize(e)}`]:ve(t),[`_all${m.pluralize(e)}Meta`]:Pe(t),[e]:Re(t)}),Be=(e,t)=>({[`create${e}`]:ue(t),[`createMany${e}`]:$e(t),[`update${e}`]:Me(t),[`remove${e}`]:Z(t),[`delete${e}`]:Z(t)}),le=e=>Object.assign({},{Query:Object.keys(e).reduce((t,r)=>Object.assign({},t,Ce(j(r),e[r])),{}),Mutation:Object.keys(e).reduce((t,r)=>Object.assign({},t,Be(j(r),e[r])),{})},Object.keys(e).reduce((t,r)=>Object.assign({},t,{[j(r)]:Ve(r,e)}),{}),k(U,e)?{Date:re}:{},k("JSON",e)?{JSON:C.GraphQLJSON}:{}),he=e=>ge.makeExecutableSchema({typeDefs:o.printSchema(ce(e)),resolvers:le(e)}),Ue=e=>({typeDefs:o.printSchema(ce(e)),resolvers:le(e)}),Je=(e,t)=>(t.writeHead(200,void 0,{"Content-Type":"text/html; charset=utf-8"}),t.end(qe({endpoint:"/graphql"}))),qe=({endpoint:e})=>`
<!--
 *  Copyright (c) 2021 GraphQL Contributors
 *  All rights reserved.
 * Copy of https://github.com/graphql/graphiql/blob/main/examples/graphiql-cdn/index.html
 * https://github.com/graphql/graphiql
 * https://github.com/graphql/graphiql/blob/main/LICENSE
-->
<!doctype html>
<html lang="en">
  <head>
    <title>GraphiQL</title>
    <style>
      body {
        height: 100%;
        margin: 0;
        width: 100%;
        overflow: hidden;
      }

      #graphiql {
        height: 100vh;
      }
    </style>
    <script
      crossorigin
      src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"
    ><\/script>
    <script
      crossorigin
      src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"
    ><\/script>
    <!--
      These two files can be found in the npm module, however you may wish to
      copy them directly into your environment, or perhaps include them in your
      favored resource bundler.
     -->
    <script
      src="https://cdn.jsdelivr.net/npm/graphiql/graphiql.min.js"
      type="application/javascript"
    ><\/script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/graphiql/graphiql.min.css" />
    <!-- 
      These are imports for the GraphIQL Explorer plugin.
     -->
    <script
      src="https://cdn.jsdelivr.net/npm/@graphiql/plugin-explorer/dist/index.umd.js"
      crossorigin
    ><\/script>

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@graphiql/plugin-explorer/dist/style.css"
    />
  </head>

  <body>
    <div id="graphiql">Loading...</div>
    <script>
      const root = ReactDOM.createRoot(document.getElementById('graphiql'));
      const fetcher = GraphiQL.createFetcher({
        url: '${e}',
      });
      const explorerPlugin = GraphiQLPluginExplorer.explorerPlugin();
      root.render(
        React.createElement(GraphiQL, {
          fetcher,
          defaultEditorToolsVisibility: true,
          plugins: [explorerPlugin],
        }),
      );
    <\/script>
  </body>
</html>`,fe=e=>{const t=Te({schema:he(e)});return(n,s,a)=>n.is("application/json")?t(n,s,a):Je(n,s)},Ye=he;exports.default=fe;exports.getPlainSchema=Ue;exports.jsonGraphqlExpress=fe;exports.jsonSchemaBuilder=Ye;
//# sourceMappingURL=json-graphql-server-node.cjs.map
